name: Build

on:
  push:
    tags: ["v*"]

env:
  PYTHON_VERSION: "3.13"
  FLET_CLI_VERSION: "0.80.5"
  FLUTTER_VERSION: "3.38.x"
  JAVA_VERSION: "17"
  PYTHONUTF8: 1
  FLET_CLI_NO_RICH_OUTPUT: 1

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install Linux build toolchain
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            clang cmake ninja-build libgtk-3-dev

      - name: Install flet-cli
        run: pip install flet-cli==${{ env.FLET_CLI_VERSION }}

      - name: Build Linux app
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0"
          fi
          flet build linux \
            --org com.ghosty \
            --project client \
            --product GHosty \
            --verbose \
            --build-number=${{ github.run_number }} \
            --build-version="$VERSION" \
            --exclude .venv .git .github build aar.txt

      - name: Rename executable
        run: |
          cd build/linux
          EXE=$(find . -maxdepth 1 -type f -executable | head -1)
          if [ -n "$EXE" ]; then
            mv "$EXE" ghosty-client.bin
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: GHosty-linux
          path: build/linux
          if-no-files-found: error

  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install flet-cli
        run: pip install flet-cli==${{ env.FLET_CLI_VERSION }}

      - name: Build APK
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0"
          fi
          flet build apk \
            --org com.ghosty \
            --project client \
            --product GHosty \
            --verbose \
            --build-number=${{ github.run_number }} \
            --build-version="$VERSION" \
            --exclude .venv .git .github build aar.txt

      - uses: actions/upload-artifact@v4
        with:
          name: GHosty-apk
          path: build/apk/app-release.apk
          if-no-files-found: error

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-apk]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Delete all existing releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASES=$(gh release list --json tagName -q '.[].tagName' 2>/dev/null || true)
          if [ -n "$RELEASES" ]; then
            for TAG in $RELEASES; do
              echo "Deleting release $TAG ..."
              gh release delete "$TAG" --yes --cleanup-tag=false
            done
          else
            echo "No existing releases to delete"
          fi

      - uses: actions/download-artifact@v4
        with:
          name: GHosty-linux
          path: artifacts/linux

      - uses: actions/download-artifact@v4
        with:
          name: GHosty-apk
          path: artifacts/apk

      - name: Verify artifacts exist
        run: |
          test -d artifacts/linux || { echo "::error::Linux artifact missing"; exit 1; }
          test -f artifacts/apk/app-release.apk || { echo "::error::APK artifact missing"; exit 1; }
          echo "Both artifacts present"

      - name: Package artifacts
        run: |
          TAG="${{ github.ref_name }}"
          cd artifacts/linux
          tar -czf "../../ghosty-linux-${TAG}.tar.gz" .
          cd ../..
          cp artifacts/apk/app-release.apk "ghosty-android-${TAG}.apk"

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ github.ref_name }}"
          gh release create "$TAG" \
            --generate-notes \
            "ghosty-linux-${TAG}.tar.gz" \
            "ghosty-android-${TAG}.apk"
